syntax = "proto3";

package com.intentevolved;

// Kotlin/Java classes will be generated under com.intentevolved
option java_package = "com.intentevolved";
option java_multiple_files = true;

message IntentStream {
  Header header = 1;
  repeated Op ops = 2;
}


message Header {
  // a text description of the end intent of the whole stream
  // this object is effectively an intent with id '0'
  string rootIntent = 1;
  // todo: other details, like who wrote it, date started, etc

}
message Op {
  oneof payload {
    CreateIntent create_intent = 1;
    UpdateIntentText update_intent = 2;
    DeleteIntent delete_intent = 3;
    FulfillIntent fulfill_intent = 4;
    UpdateIntentParent update_intent_parent = 5;
    AddField add_field = 6;
    SetFieldValue set_field_value = 7;
  }
  // bump field numbers up here to leave space for more messages

  // Unique id for this op (the op is also an intent)
  int64 id = 100;
  optional int64 timestamp_epoch_nanos = 1000;
}

message CreateIntent {
  string text = 1;
  // having a parent is optional
  // if you don't explicitly specify a parent, the 'root' intent is the parent
  optional int64 parentId = 2;
}

message UpdateIntentText {
  int64 id = 1;
  string new_text = 2;
}

message UpdateIntentParent {
  int64 id = 1;
  int64 parentId = 2;
}

message DeleteIntent {
  int64 id = 1;
}

message AddField {
  int64 intentId = 1;
  string fieldName = 2;
  FieldType fieldType = 3;
  optional bool required = 4;  // Is this field mandatory?
  optional string description = 5;  // What's this field for?
  // todo: enums
}

enum FieldType {
  FIELD_TYPE_UNSPECIFIED = 0;
  FIELD_TYPE_STRING = 1;
  FIELD_TYPE_INT32 = 2;
  FIELD_TYPE_INT64 = 3;
  FIELD_TYPE_FLOAT = 4;
  FIELD_TYPE_DOUBLE = 5;
  FIELD_TYPE_BOOL = 6;
  FIELD_TYPE_TIMESTAMP = 8;  // Epoch nanos
  FIELD_TYPE_INTENT_REF = 9;  // Reference to another intent by ID
}

// For setting values on fields you've defined
message SetFieldValue {
  int64 intentId = 1;
  string fieldName = 2;
  oneof value {
    string string_value = 3;
    int32 int32_value = 4;
    int64 int64_value = 5;
    float float_value = 6;
    double double_value = 7;
    bool bool_value = 8;
    int64 timestamp_value = 9;
    int64 intent_ref_value = 10;
  }
}

// For defining enums that can be used in AddField
// todo: enums

// eventually this will become more complex
// once the stream works for multiple authors, there'll be a mechanism where
// - one agent says, I've fullfilled the intent
// - stream owner says "i've confirmed this fulfilled the intent"
message FulfillIntent {
  int64 id = 1;
}

// ============================================================================
// gRPC Service Definition
// ============================================================================

service IntentService {
  // Submit an operation (id and timestamp will be assigned by the server)
  rpc SubmitOp(SubmitOpRequest) returns (SubmitOpResponse);

  // Get an intent by its ID
  rpc GetIntent(GetIntentRequest) returns (GetIntentResponse);

  // Get the focal scope for an intent
  rpc GetFocalScope(GetFocalScopeRequest) returns (GetFocalScopeResponse);
}

// Request to submit an operation - contains just the payload, no id or timestamp
message SubmitOpRequest {
  oneof payload {
    CreateIntent create_intent = 1;
    UpdateIntentText update_intent = 2;
    DeleteIntent delete_intent = 3;
    FulfillIntent fulfill_intent = 4;
    UpdateIntentParent update_intent_parent = 5;
    AddField add_field = 6;
    SetFieldValue set_field_value = 7;
  }
}

message SubmitOpResponse {
  bool success = 1;
  string message = 2;
  int64 id = 3;  // The assigned id for the op/intent
}

message GetIntentRequest {
  int64 id = 1;
}

message GetIntentResponse {
  bool found = 1;
  IntentProto intent = 2;
  string error = 3;  // Error message if not found
}

message GetFocalScopeRequest {
  int64 id = 1;
}

message GetFocalScopeResponse {
  bool found = 1;
  IntentProto focus = 2;
  repeated IntentProto ancestry = 3;
  repeated IntentProto children = 4;
  string error = 5;  // Error message if not found
}

// Proto representation of an Intent for API responses
message IntentProto {
  int64 id = 1;
  string text = 2;
  optional int64 parent_id = 3;
  optional int64 created_timestamp = 4;
  optional int64 last_updated_timestamp = 5;
  bool is_meta = 6;
  map<string, FieldDetailsProto> fields = 7;
  map<string, FieldValueProto> field_values = 8;
}

message FieldDetailsProto {
  FieldType field_type = 1;
  bool required = 2;
  optional string description = 3;
}

message FieldValueProto {
  oneof value {
    string string_value = 1;
    int32 int32_value = 2;
    int64 int64_value = 3;
    float float_value = 4;
    double double_value = 5;
    bool bool_value = 6;
    int64 timestamp_value = 7;
    int64 intent_ref_value = 8;
  }
}
